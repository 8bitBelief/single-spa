{"version":3,"file":"single-spa-bundle.js","sources":["../../src/application/appsHelper.js","../../src/start.js","../../src/lifecycles/helper.js","../../src/lifecycles/load.js","../../src/navigations/invoke.js","../../src/application/app.js"],"sourcesContent":["export const NOT_LOADED = 'NOT_LOADED';\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN';\nexport const LOAD_ERROR = 'LOAD_ERROR'\nexport const LOAD_SOURCE_CODE = 'LOAD_SOURCE_CODE'\n\n\n// import { NOT_LOADED, notLoadError, notSkip, isntLoaded, shouldBeActivity } from './appsHelper';\nexport function notSkip(app) {\n    return app.status !== SKIP_BECAUSE_BROKEN;\n}\n\nexport function notLoadError(app) {\n    return app.status !== LOAD_ERROR;\n}\n\nexport function isntLoaded(app) {\n    return app.status === NOT_LOADED;\n}\n\nexport function shouldBeActivity(app) {\n    try {\n        return app.activityWhen(window.location)\n    }catch(e) {\n        app.status = SKIP_BECAUSE_BROKEN\n        console.log(e)\n    }\n}","export function start() {\n\n}\n\n\nlet started = false;  \n\nexport function isStarted() {\n    return started\n}","export function smelLikeAPromise(promise) {\n    if(promise instanceof Promise) {\n        return true \n    }\n\n    return typeof promise === 'object' && typeof promise.then === 'function' && typeof promise.catch === 'function'\n}\n\n/**\n * \n * @param {*} lifecycles \n * @param {*} description \n */\nexport function flattenLifecyclesArray(lifecycles, description) {\n    if(Array.isArray(lifecycles)) {\n        lifecycles = [lifecycles]\n    }\n\n    if(!lifecycles.length) {\n        lifecycles = [() => Promise.resolve()]\n    }\n\n    return new Promise((resolve, reject) => {\n        waitForPromises(0)\n\n        function waitForPromises(index) {\n            let fn = lifeCycles[index]();\n\n            if(!smelLikeAPromise(fn)) {\n                reject(new Error(`${description} has error`))\n            }else {\n                fn.then(() => {\n                    if(index >= lifecycles.length - 1) {\n                        resolve()\n                    }else {\n                        waitForPromises(++index)\n                    }\n                }).catch(reject)\n            }\n        }\n    })\n}","import { NOT_LOADED, LOAD_SOURCE_CODE, SKIP_BECAUSE_BROKEN } from \"../application/appsHelper\";\nimport { smelLikeAPromise, flattenLifecyclesArray } from \"./helper\";\n\n\nexport function toLoadPromise(app) {\n    if(app.status !== NOT_LOADED) {\n        return Promise.resolve(app)\n    }\n\n    app.status = LOAD_SOURCE_CODE;\n\n    let loadPromise = app.loadFunction()\n\n    if(!smelLikeAPromise(loadPromise)) {\n        return Promise.reject(new Error('加载函数不是一个promise'));\n\n        loadPromise.then(appConfig => {\n            if(typeof appConfig !== 'object') {\n                throw new Error('')\n            }\n\n            let errors = []\n            [\"bootstrap\", 'mount', 'unmount'].forEach(lifecycle => {\n                if(!appConfig[lifecycle]) {\n                    errors.push('lifecycle:' + lifecycle + 'must be exists')\n                }\n            })\n\n            if(errors.length) {\n                app.status = SKIP_BECAUSE_BROKEN;\n                console.log(errors);\n                return\n            }\n            \n            app.bootstrap = flattenLifecyclesArray(appConfig.bootstrap, `app: ${app.name} bootstraping`);\n            app.mount = flattenLifecyclesArray(appConfig.mount, `app: ${app.name} mounting`);\n            app.unmount = flattenLifecyclesArray(appConfig.unmount, `app: ${app.name} unmounting`);\n\n        })\n    } \n}","import { isStarted } from '../start'\nimport { getAppsToLoad } from '../application/app'\nimport { toLoadPromise } from '../lifecycles/load'\n\nlet appChangesUnderway = false;\nlet changesQueue = [];\n\nexport function invoke() {\n    // 现检查appChanges有没有在做事件循环\n    if(appChangesUnderway) {\n        return new Promise((resolve, reject) => {\n            changesQueue.push({\n                success: resolve,\n                failure: reject\n            })\n        })\n    }\n\n    appChangesUnderway = true\n\n    // 判断应用是否启动\n    if(isStarted()) {\n\n    }else {\n        // 如果应用没有启动， 那么启动应用\n        loadApps()\n    }\n\n    function loadApps() {\n        // 获取需要被加载的app\n        let apps = getAppsToLoad()\n        \n        apps.map(toLoadPromise)\n    }\n}","import { NOT_LOADED, notLoadError, notSkip, isntLoaded, shouldBeActivity } from './appsHelper';\nimport { invoke } from '../navigations/invoke';\n\n/**\n * @function 注册App\n * @param {string} appName 要注册的app的名称\n * @param {Function: Promise | Object} loadFunction app异步加载函数， 或者app的内容\n * @param {Function: boolean} activityWhen  判断该app应该何时启动\n * @param {Object} customProps  自定义参数配置\n * return Promise\n */\nconst APPS = []\nexport function registerApplication(appName, loadFunction, activityWhen, customProps) {\n    // 判断参数是否合法\n    if(!appName || typeof appName !== 'string') {\n        throw new Error('appName不可以是一个空字符串')\n    }\n    if(!loadFunction) {\n        throw new Error('loadFunction must be a function or object')\n    }\n    if(typeof loadFunction !== 'function') {\n        loadFunction = () => Promise.resolve(loadFunction)\n    }\n    if(typeof activityWhen !== 'function') {\n        throw new Error('activityWhen must be a function')\n    }\n\n    APPS.push({\n        name: appName,\n        loadFunction,\n        activityWhen,\n        customProps,\n        status: NOT_LOADED\n    })\n\n    invoke();\n}\n\n/**\n * @function 获取需要被加载的app\n */\nexport function getAppsToLoad() {\n    return APPS.filter(notSkip).filter(notLoadError).filter(isntLoaded).filter(shouldBeActivity)\n}\n\n"],"names":["NOT_LOADED","SKIP_BECAUSE_BROKEN","LOAD_ERROR","LOAD_SOURCE_CODE","notSkip","app","status","notLoadError","isntLoaded","shouldBeActivity","activityWhen","window","location","e","console","log","start","smelLikeAPromise","promise","Promise","then","catch","toLoadPromise","resolve","loadPromise","loadFunction","reject","Error","appChangesUnderway","invoke","loadApps","apps","getAppsToLoad","map","APPS","registerApplication","appName","customProps","push","name","filter"],"mappings":"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"}